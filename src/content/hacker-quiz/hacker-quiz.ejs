<style>
  .spinner-container {
    max-width: 600px;
    margin: 0 auto;
    background-color: rgb(50, 50, 50);
    height: 200px;
    overflow: hidden;
    border-radius: 16px;
    position: relative;
  }

  .spinner-container::before,
  .spinner-container::after {
    content: '';
    position: absolute;
    left: 0;
    width: 100%;
    height: 50px;
    z-index: 2;
    pointer-events: none;
  }

  .spinner-container::before {
    top: 0;
    background: linear-gradient(to bottom, #222, transparent);
  }

  .spinner-container::after {
    bottom: 0;
    background: linear-gradient(to top, #222, transparent);
  }

  /* Der Wrapper, der sich bewegt */
  .scroll-wrapper {
  }

  .topic {
    color: white;
    text-align: center;
    padding: 9px;
    border-bottom: 1px solid #696969;
    font-size: 30px;
    white-space: nowrap;
    user-select: none;
  }

  #quiz-question {
    text-align: center;
    padding: 16px;
    font-size: 24px;
    font-weight: bold;
    border: 1px solid var(--main-color);
    border-radius: 12px;
  }

  #quiz-question-1,
  #quiz-question-2,
  #quiz-question-3,
  #quiz-question-4 {
    flex-basis: 45%;
    padding: 16px;
    cursor: pointer;
    text-align: center;
    border: 1px solid white;
    border-radius: 8px;
    font-size: 20px;
    user-select: none;
  }

  .row-1,
  .row-2 {
    display: flex;
    justify-content: space-around;
    margin-top: 24px;
  }
</style>

<div class="spinner-container">
  <div class="scroll-wrapper"></div>
</div>

<div style="text-align: center; margin-top: 32px" class="spinner-start-button">
  <button class="btn btn-interaction btn-lg" id="spinner-start">Start</button>
</div>

<div class="quiz-ui" style="display: none">
  <div id="quiz-question"></div>
  <div class="options-container">
    <div class="row-1">
      <div id="quiz-question-1"></div>
      <div id="quiz-question-2"></div>
    </div>
    <div class="row-2">
      <div id="quiz-question-3"></div>
      <div id="quiz-question-4"></div>
    </div>
  </div>
</div>

<script>
  // hacking related questions, options are only words / very short, correct answer is always first
  const topics = [
    {
      id: 1,
      de: {
        topic: 'Netzwerk',
        questions: [
          {
            question:
              'Welches Protokoll wird verwendet, um Webseiten zu laden?',
            options: ['HTTP', 'FTP', 'SMTP', 'DNS'],
          },
          {
            question:
              'Welches Gerät verbindet verschiedene Netzwerke miteinander?',
            options: ['Router', 'Switch', 'Modem', 'Firewall'],
          },
          {
            question: 'Welche IP-Version ist die aktuellste?',
            options: ['IPv6', 'IPv4', 'IPX', 'IPV2'],
          },
        ],
      },
    },
    {
      id: 2,
      de: {
        topic: 'Passwörter',
        questions: [
          {
            question: 'Was bedeutet MFA? ',
            options: [
              'Multi-Faktor-Authentifizierung',
              'Mein-Foto-Album',
              'Mail-Forwarding-Account',
              'Mehrfach-File-Archiv',
            ],
          },
          {
            question: 'Welche Methode ist am sichersten? ',
            options: ['Passphrase', 'Name+Geburtstag', '123456', 'Passwort'],
          },
          {
            question: 'Was ist ein Passwort-Manager? ',
            options: [
              'Tool zum Speichern/Generieren',
              'Browser-Cache',
              'VPN',
              'Firewall',
            ],
          },
        ],
      },
    },
    {
      id: 3,
      de: {
        topic: 'Web-Sicherheit',
        questions: [
          {
            question: 'Welche Schwachstelle betrifft ungefilterte Eingaben? ',
            options: ['XSS', 'DDoS', 'DNS', 'NTP'],
          },
          {
            question: 'Wofür steht CSRF? ',
            options: [
              'Cross-Site Request Forgery',
              'Client-Side Render Flow',
              'Cookie Session Reset Flag',
              'Cache State Refresh Function',
            ],
          },
          {
            question: 'Welches Flag schützt Cookies vor JS-Zugriff? ',
            options: ['HttpOnly', 'Readable', 'Public', 'Inline'],
          },
        ],
      },
    },
  ]

  // create a div for every topic (de), only topic, very simple
  const wrapper = document.querySelector('.scroll-wrapper')
  for (const x of [0, 1]) {
    topics.forEach((topic) => {
      const topicDiv = document.createElement('div')
      topicDiv.classList.add('topic')
      topicDiv.classList.add(`topic-${topic.id}`)
      topicDiv.innerHTML = `<div>${topic.de.topic}</div>`
      wrapper.appendChild(topicDiv)
    })
  }

  const WRAPPER_HEIGHT = wrapper.offsetHeight / 2
  const ELEMENT_HEIGHT = WRAPPER_HEIGHT / topics.length
  const MIDDLE_POS = 155
  const MAX_SPEED = 3000

  let pos = 0
  let speed = 15 // pixels per second
  let lastTime = null
  let mode = 'READY' // 'SLOWDOWN', 'ACCEL'
  let slowDownK = 0
  let slowDownStartPos = 0
  let slowDownStartT = 0

  let selectedIndex = 0

  let round = null
  let quizIndex = 0

  function loop() {
    const now = performance.now()
    const delta = now - lastTime
    if (mode == 'SLOWDOWN') {
      const expo = Math.exp(-slowDownK * ((now - slowDownStartT) / 1000))
      speed = MAX_SPEED * expo
      pos =
        (slowDownStartPos + (MAX_SPEED / slowDownK) * (1 - expo)) %
        WRAPPER_HEIGHT
      if (speed <= 3) {
        speed = 0
        mode = 'STOP'
        // highlight selected topic
        const selectedTopicDiv = document.querySelectorAll(
          `.topic-${topics[selectedIndex].id}`
        )
        selectedTopicDiv.forEach((div) => {
          div.style.backgroundColor = 'rgba(var(--main-color-rgb), 0.3)'
        })
        setTimeout(() => {
          // hide spinner and show quiz ui
          document.querySelector('.spinner-container').style.display = 'none'
          document.querySelector('.spinner-start-button').style.display = 'none'
          const quizUI = document.querySelector('.quiz-ui')
          quizUI.style.display = 'block'

          round = topics[selectedIndex].de
          quizIndex = 0
          document.getElementById('back-button').style.visibility = 'hidden'
          prepareQuiz()
        }, 1000)
      }
    } else {
      pos += speed * (delta / 1000)
      if (pos >= WRAPPER_HEIGHT) {
        pos -= WRAPPER_HEIGHT
      }
    }
    wrapper.style.transform = `translateY(-${pos}px)`

    // add blur on higher speeds
    const blurAmount = Math.min(speed / 1600, 4)
    wrapper.style.filter = `blur(${blurAmount}px)`

    lastTime = now
    requestAnimationFrame(loop)
  }

  document
    .getElementById('spinner-start')
    .addEventListener('click', async () => {
      if (mode != 'READY') return

      const topicsDivs = document.querySelectorAll('.topic')
      topicsDivs.forEach((div) => {
        div.style.backgroundColor = ''
      })

      selectedIndex = Math.floor(Math.random() * topics.length)
      console.log(topics[selectedIndex].de.topic)

      mode = 'ACCEL'
      if (mode != '') speed = 300
      await sleep(150)
      speed = 700
      await sleep(100)
      speed = MAX_SPEED
      await sleep(1600)

      // todo: calculate slowdown parameters
      slowDownStartPos = pos
      // slowDownK = 2.45
      slowDownStartT = performance.now()

      const targetPos =
        (MIDDLE_POS - ELEMENT_HEIGHT / 2 + selectedIndex * ELEMENT_HEIGHT) %
        WRAPPER_HEIGHT

      let decelDistance = targetPos + WRAPPER_HEIGHT - slowDownStartPos

      while (decelDistance < MAX_SPEED / 2.45) {
        decelDistance += WRAPPER_HEIGHT
      }

      slowDownK = (MAX_SPEED - 3) / decelDistance

      mode = 'SLOWDOWN'
    })

  function prepareQuiz() {
    const quizQuestionDiv = document.getElementById('quiz-question')
    const option1Div = document.getElementById('quiz-question-1')
    const option2Div = document.getElementById('quiz-question-2')
    const option3Div = document.getElementById('quiz-question-3')
    const option4Div = document.getElementById('quiz-question-4')

    const currentQuestion = round.questions[quizIndex]

    quizQuestionDiv.innerHTML = currentQuestion.question
    option1Div.innerHTML = currentQuestion.options[0]
    option2Div.innerHTML = currentQuestion.options[1]
    option3Div.innerHTML = currentQuestion.options[2]
    option4Div.innerHTML = currentQuestion.options[3]
  }

  async function sleep(ms) {
    return new Promise((resolve) => setTimeout(resolve, ms))
  }

  lastTime = performance.now()
  loop()
</script>
