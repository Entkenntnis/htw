
<p><a href="/map"><%= t('challenge.back') %></a></p>

<%- include('../partials/languagePicker', {t, App, locale}) %>

<p><%= t('username') %> <%= user.name %></p>
<p><%= t('score') %> <%= user.score %></p>
<% if (props.rank) { %>
  <p><%= t('rank') %>: <%= props.rank %> <span style="color:#dddddd;margin-left:12px;">(von <%= props.sum %>, Top <%= Math.ceil(props.rank * 100 / props.sum) %>%)</span></p>
<% } %>
<p><%= t('solved', {main: props.solved - user.community, community: user.community}) %></p>
<p><%= t('registered') %> <%= App.moment(user.createdAt).locale(locale).fromNow() %> (<%= App.moment(user.createdAt).locale(locale).format("LLLL") %>)</p>
<p><%= t('lastActive') %> <%= App.moment(props.lastActive).locale(locale).fromNow() %> (<%= App.moment(props.lastActive).locale(locale).format("LLLL") %>)</p>
<% if (props.lastChal) { %>
  <p><%= t('lastSolved') %>: <%= props.lastChal %></p>
<% } %>

<% if (props.room) { %>
  <hr />

  <p><%= t('room') %> <%= props.room%></p>
  <% if (user.session_phase === 'READY') { %>
    <p><%= t('sessionReady') %></p>
    <p><a href="/startsession"><%= t('startSession') %></a></p>
  <% } %>
  <% if (user.session_phase === 'ACTIVE') { %>
    <p><%= t('sessionActive') %></p>
    <p><a href="/endsession"><%= t('endSession') %></a></p>
  <% } %>
  <% if (user.session_phase === 'DONE') { %>
    <p><%= t('sessionDone') %></p>
    <p><%= t('sessionScore') %> <%= user.session_score %></p>
  <% } %>
<% } %>

<% if (!App.config.demos.includes(user.name)) { %>
  <p style="color: gray;">
    <a href="https://www.wechall.net/" style="color: gray" target="_blank"><strong>WeChall</strong></a>-Token: <%= props.token %> 
    <button onclick="copyToken()" id="copy-button" style="background:none;border:none;padding:0;cursor:pointer;width:12px;height:12px;margin-left:8px;outline:none" title="<%= t('copy') %>">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="gray" d="M384 336l-192 0c-8.8 0-16-7.2-16-16l0-256c0-8.8 7.2-16 16-16l140.1 0L400 115.9 400 320c0 8.8-7.2 16-16 16zM192 384l192 0c35.3 0 64-28.7 64-64l0-204.1c0-12.7-5.1-24.9-14.1-33.9L366.1 14.1c-9-9-21.2-14.1-33.9-14.1L192 0c-35.3 0-64 28.7-64 64l0 256c0 35.3 28.7 64 64 64zM64 128c-35.3 0-64 28.7-64 64L0 448c0 35.3 28.7 64 64 64l192 0c35.3 0 64-28.7 64-64l0-32-48 0 0 32c0 8.8-7.2 16-16 16L64 464c-8.8 0-16-7.2-16-16l0-256c0-8.8 7.2-16 16-16l32 0 0-48-32 0z"/></svg>
    </button>
  </p>
  
  <p style="color: gray;">
    <a href="/export-data" style="color: gray"><%= t('exportData') %></a>
  </p>

  <p style="text-align:right" id="change-pw"><a href="/changepw"><%= t('changepw') %></a></p>
  <p style="text-align:right" id="rename-user"><a href="/rename"><%= t('rename') %></a></p>

  <p style="text-align:right"><a href="/delete"><%= t('delete') %></a></p>

<% } %>


<div style="margin-top: 48px;">
<% if (!App.config.demos.includes(user.name)) { %>
  <p style="margin-top: 24px; max-width: 65ch;"><%- t('discordLinkingNote_', { link: `<a href="/link-discord">${t('discordLink')}</a>` }) %></p>
<% } %>
</div>

<script>
  function copyToken() {
    const token = '<%= props.token %>';
    navigator.clipboard.writeText(token).then(() => {
      const button = document.getElementById('copy-button');
      button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="green" d="M504 75c9.4 9.4 9.4 24.6 0 33.9l-272 272c-9.4 9.4-24.6 9.4-33.9 0l-136-136c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0L224 318.1 470.1 75c9.4-9.4 24.6-9.4 33.9 0z"/></svg>';
    }).catch(err => {
      console.error('Failed to copy token: ', err);
    });
  }
</script>

<!-- theme section -->
<div style="
    border: 1px solid #313030;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: saturate(120%) blur(2px);
    width: 100%;
    padding: 16px;
    margin-top: 96px;
">
  <p><%= t('theme')%>:</p>
  <div style="
    display: flex;
    flex-direction: row;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 20px;
  ">
    <div class="theme-option" data-color="#00bc8c">OG</div>
    <div class="theme-option" data-color="#ffffbd">calm</div>
    <div class="theme-option" data-color="#1bcf00">neon</div>
    <div class="theme-option" data-color="#d888ca">kawaii</div>
    <div class="theme-option" data-color="#ff0000">rudolph</div> 
    <div class="theme-option" data-color="#a388ec">lavender</div>
    <div class="theme-option" data-color="#ff8000">pumpkin</div>
  </div>
  <hr style="margin-top: 40px;">
  <div style="margin-top: 20px;">
    <label for="maincolor-input" style="margin-right: 8px;"><%= t('mainColor') %>:</label>
    <input type="color" id="maincolor-input" name="color" style="vertical-align: middle;">
  </div>
  <style>
    .theme-option {
      width: 120px;
      height: 60px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      user-select: none;
      font-size: 16px;
    }
  </style>
  <script>
    (() => {
      const throttle = (fn, waitMs) => {
        let lastCallAt = 0;
        let timeoutId = null;
        let lastArgs;
        let lastThis;

        return function throttled(...args) {
          const now = Date.now();
          lastArgs = args;
          lastThis = this;
          const remaining = waitMs - (now - lastCallAt);

          if (remaining <= 0) {
            if (timeoutId) {
              clearTimeout(timeoutId);
              timeoutId = null;
            }
            lastCallAt = now;
            fn.apply(lastThis, lastArgs);
            return;
          }

          if (!timeoutId) {
            timeoutId = setTimeout(() => {
              timeoutId = null;
              lastCallAt = Date.now();
              fn.apply(lastThis, lastArgs);
            }, remaining);
          }
        };
      };

      const options = document.querySelectorAll('.theme-option');
      const currentCssVal = getComputedStyle(document.documentElement).getPropertyValue('--main-color')
      options.forEach(option => {
        // set background colors and highlight current
        const color = option.getAttribute('data-color');
        //option.style.backgroundColor = color;
        if (color.trim() === currentCssVal.trim()) {
          option.style.backgroundColor = '#444'
        }
        option.style.color = color;
        option.style.borderColor = color;

        option.addEventListener('click', () => {
          const color = option.getAttribute('data-color');

          // do post fetch request in the background
          fetch('/setmaincolor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'color=' + encodeURIComponent(color)
          })

          // reflect immediately
          document.documentElement.style.setProperty('--main-color', color);
          // update UI
          options.forEach(opt => {
            opt.style.backgroundColor = 'transparent'
          });
          option.style.backgroundColor = '#444'
        });
      });

      var input = document.getElementById('maincolor-input');
      input.value = currentCssVal.trim();

      const postMainColorThrottled = throttle((color) => {
        fetch('/setmaincolor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'color=' + encodeURIComponent(color)
        })
      }, 1000);

      input.addEventListener('input', () => {
        const color = input.value;
        // do post fetch request in the background (throttled)
        postMainColorThrottled(color);
        // reflect immediately
        document.documentElement.style.setProperty('--main-color', color);
        // update UI
        options.forEach(opt => {
          opt.style.backgroundColor = 'transparent'
        });
      });
      // on input click, update color to current
      input.addEventListener('click', () => {
        input.value = getComputedStyle(document.documentElement).getPropertyValue('--main-color').trim();
      });
    })()
  </script>
</div>
<!-- end of theme section -->

<div style="height:120px"></div>

<ul class="d-flex flex-row list-unstyled" style="margin-bottom: -55px; margin-top: 100px;">
  <li class="mr-3"><a href="/contact"><%=t('contact.heading')%></a></li>
  <li class="mr-3"><a href="/privacy"><%=t('home.privacyLink')%></a></li>
  <li class="mr-3"><a href="https://github.com/Entkenntnis/htw/releases" target="_blank"><%=t('home.news')%></a></li>
  <li><a href="/links">Links</a></li>
  <li>
    <a href="https://discord.gg/9zDMZP9edd" target="_blank" class="discord-link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M524.5 133.8C524.3 133.5 524.1 133.2 523.7 133.1C485.6 115.6 445.3 103.1 404 96C403.6 95.9 403.2 96 402.9 96.1C402.6 96.2 402.3 96.5 402.1 96.9C396.6 106.8 391.6 117.1 387.2 127.5C342.6 120.7 297.3 120.7 252.8 127.5C248.3 117 243.3 106.8 237.7 96.9C237.5 96.6 237.2 96.3 236.9 96.1C236.6 95.9 236.2 95.9 235.8 95.9C194.5 103 154.2 115.5 116.1 133C115.8 133.1 115.5 133.4 115.3 133.7C39.1 247.5 18.2 358.6 28.4 468.2C28.4 468.5 28.5 468.7 28.6 469C28.7 469.3 28.9 469.4 29.1 469.6C73.5 502.5 123.1 527.6 175.9 543.8C176.3 543.9 176.7 543.9 177 543.8C177.3 543.7 177.7 543.4 177.9 543.1C189.2 527.7 199.3 511.3 207.9 494.3C208 494.1 208.1 493.8 208.1 493.5C208.1 493.2 208.1 493 208 492.7C207.9 492.4 207.8 492.2 207.6 492.1C207.4 492 207.2 491.8 206.9 491.7C191.1 485.6 175.7 478.3 161 469.8C160.7 469.6 160.5 469.4 160.3 469.2C160.1 469 160 468.6 160 468.3C160 468 160 467.7 160.2 467.4C160.4 467.1 160.5 466.9 160.8 466.7C163.9 464.4 167 462 169.9 459.6C170.2 459.4 170.5 459.2 170.8 459.2C171.1 459.2 171.5 459.2 171.8 459.3C268 503.2 372.2 503.2 467.3 459.3C467.6 459.2 468 459.1 468.3 459.1C468.6 459.1 469 459.3 469.2 459.5C472.1 461.9 475.2 464.4 478.3 466.7C478.5 466.9 478.7 467.1 478.9 467.4C479.1 467.7 479.1 468 479.1 468.3C479.1 468.6 479 468.9 478.8 469.2C478.6 469.5 478.4 469.7 478.2 469.8C463.5 478.4 448.2 485.7 432.3 491.6C432.1 491.7 431.8 491.8 431.6 492C431.4 492.2 431.3 492.4 431.2 492.7C431.1 493 431.1 493.2 431.1 493.5C431.1 493.8 431.2 494 431.3 494.3C440.1 511.3 450.1 527.6 461.3 543.1C461.5 543.4 461.9 543.7 462.2 543.8C462.5 543.9 463 543.9 463.3 543.8C516.2 527.6 565.9 502.5 610.4 469.6C610.6 469.4 610.8 469.2 610.9 469C611 468.8 611.1 468.5 611.1 468.2C623.4 341.4 590.6 231.3 524.2 133.7zM222.5 401.5C193.5 401.5 169.7 374.9 169.7 342.3C169.7 309.7 193.1 283.1 222.5 283.1C252.2 283.1 275.8 309.9 275.3 342.3C275.3 375 251.9 401.5 222.5 401.5zM417.9 401.5C388.9 401.5 365.1 374.9 365.1 342.3C365.1 309.7 388.5 283.1 417.9 283.1C447.6 283.1 471.2 309.9 470.7 342.3C470.7 375 447.5 401.5 417.9 401.5z"/></svg>
      <span>Discord</span>
    </a>
    <style>
      .discord-link {
        margin-left: 48px;
        display:flex;
        align-items:center;
      }
      .discord-link svg {
        height:20px;
        margin-right:5px;
      }
    </style>
  </li>
</ul>

<div style="height:70px"></div>
